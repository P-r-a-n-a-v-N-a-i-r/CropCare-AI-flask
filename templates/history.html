<!DOCTYPE html>
<html lang="en" class="min-h-screen bg-gradient-to-b from-muted/50 to-background font-sans">
<head>
  <meta charset="UTF-8" />
  <title>Detection History - CropCare AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast {
      min-width: 250px;
      max-width: 350px;
      background-color: #333;
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      opacity: 0.95;
      font-weight: 500;
      transition: opacity 0.5s ease;
    }
    .toast-success {
      background-color: #22c55e;
    }
    .toast-error {
      background-color: #ef4444;
    }
    .toggle-checkbox {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      width: 40px;
      height: 24px;
      background-color: #d1d5db;
      border-radius: 9999px;
      position: relative;
      transition: background-color 0.2s;
      cursor: pointer;
      display: inline-block;
    }
    .toggle-slider .dot {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background-color: white;
      border-radius: 9999px;
      transition: transform 0.2s ease-in-out;
    }
    .toggle-checkbox:checked + .toggle-slider {
      background-color: #4ade80;
    }
    .toggle-checkbox:checked + .toggle-slider .dot {
      transform: translateX(16px);
    }
    #delete-confirm-dialog {
      background-color: rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body>
  <div class="container mx-auto px-4 py-8 min-h-screen">

    <!-- Back button -->
    <button onclick="window.location.href='/detect'" 
      class="mb-8 flex items-center text-green-900 font-medium text-lg bg-transparent cursor-pointer">
      <svg xmlns="http://www.w3.org/2000/svg" 
        class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" 
        viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Back
    </button>

    <!-- Title -->
    <h1 class="text-4xl font-bold mb-8 flex items-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-primary" fill="none" 
        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M12 8v4l3 3" stroke-linecap="round" stroke-linejoin="round" />
        <circle cx="12" cy="12" r="9" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      Detection History
    </h1>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6">
          {% for category, message in messages %}
            <div class="p-4 mb-2 rounded {{ 'bg-red-100 text-red-700' if category == 'error' else 'bg-green-100 text-green-700' }}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- No records -->
    {% if not records %}
      <div class="p-12 text-center bg-white rounded-xl shadow">
        <svg xmlns="http://www.w3.org/2000/svg" 
          class="h-16 w-16 text-muted-foreground mx-auto mb-4" fill="none" 
          stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
        <h2 class="text-2xl font-semibold mb-2">No detections yet</h2>
        <p class="text-gray-600 mb-6">Start analyzing plants to build your detection history</p>
        <button onclick="window.location.href='/detect'" 
          class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          Analyze Your First Plant
        </button>
      </div>

    {% else %}
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
        {% for record in records %}
          <div class="bg-white rounded-lg shadow p-6 flex flex-col cursor-default hover:shadow-md transition-shadow">

            <img src="{{ record.S3Key | s3_url }}" alt="{{ record.prediction_title }}" 
                 class="w-full h-48 object-cover rounded-lg mb-4 cursor-pointer" 
                 onclick="window.location.href='/result?image_id={{ record.ImageId }}'" />

            <h3 class="text-xl font-bold truncate mb-1">{{ record.prediction_title or 'Unknown Disease' }}</h3>

            <time class="text-gray-600 text-sm mb-3 block">{{ record.timestamp }}</time>

            <p class="text-gray-700 line-clamp-3 flex-grow">{{ record.description }}</p>

            <div class="mt-4 flex items-center justify-between">

              <!-- Resolved toggle -->
              <form id="toggle-resolved-{{ record.ImageId }}" onsubmit="return false;" class="flex items-center gap-2">
                <input type="hidden" name="is_resolved" value="{{ not (record.is_resolved or False) }}" />
                <label class="flex items-center cursor-pointer select-none" onclick="event.stopPropagation();">
                  <span class="mr-2 text-sm text-muted-foreground">Resolved</span>
                  <input type="checkbox" 
                         class="toggle-checkbox" 
                         {% if record.is_resolved %}checked{% endif %}
                         onchange="event.stopPropagation(); toggleResolved('{{ record.ImageId }}', this.checked)" />
                  <span class="toggle-slider">
                    <span class="dot"></span>
                  </span>
                </label>
              </form>

              <!-- Buttons -->
              <div class="flex gap-2">
                <!-- Get Help uses JS + toast -->
                <button type="button"
                        class="px-4 py-2 border border-blue-500 text-blue-600 rounded hover:bg-blue-50 transition"
                        onclick="event.stopPropagation(); sendHelp('{{ record.ImageId }}', '{{ record.prediction_title }}', '{{ username }}', '{{ email }}');">
                  Get Help
                </button>

                <!-- Delete -->
                <button type="button"
                        class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
                        onclick="event.stopPropagation(); openDeleteDialog('{{ record.ImageId }}', this)">
                  Delete
                </button>
              </div>

            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-confirm-dialog" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full">
      <h2 class="text-xl font-semibold mb-4">Delete Detection Record</h2>
      <p class="mb-6">Are you sure you want to delete this detection record? This action cannot be undone.</p>
      <div class="flex justify-end gap-4">
        <button id="cancel-delete-btn" class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100">Cancel</button>
        <button id="confirm-delete-btn" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast-container" class="fixed top-5 right-5 space-y-2 z-50"></div>

  <script>
    // Toggle Resolved status with AJAX
    function toggleResolved(imageId, isChecked) {
      const formData = new FormData();
      formData.append('is_resolved', isChecked ? 'true' : 'false');

      fetch(`/history/edit/${imageId}`, {
        method: 'POST',
        body: formData,
      })
        .then(res => res.json())
        .then(data => {
          if (!data.success) {
            alert('Failed to update resolved status: ' + (data.message || ''));
            const checkbox = document.querySelector(`#toggle-resolved-${imageId} input[type=checkbox]`);
            if (checkbox) checkbox.checked = !isChecked;
          }
        })
        .catch(err => {
          alert('Error updating resolved status');
          console.error(err);
          const checkbox = document.querySelector(`#toggle-resolved-${imageId} input[type=checkbox]`);
          if (checkbox) checkbox.checked = !isChecked;
        });
    }

    // Delete record modal logic
    let currentDeleteBtn = null;
    let currentDeleteId = null;

    function openDeleteDialog(imageId, btnElement) {
      currentDeleteId = imageId;
      currentDeleteBtn = btnElement;
      document.getElementById('delete-confirm-dialog').classList.remove('hidden');
    }

    document.getElementById('cancel-delete-btn').addEventListener('click', () => {
      document.getElementById('delete-confirm-dialog').classList.add('hidden');
      resetDeleteButton();
    });

    document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
      if (!currentDeleteId || !currentDeleteBtn) return;

      currentDeleteBtn.disabled = true;
      currentDeleteBtn.textContent = 'Deleting...';

      try {
        const response = await fetch(`/history/delete/${currentDeleteId}`, {
          method: 'POST',
        });

        const data = await response.json();
        if (data.success) {
          const card = currentDeleteBtn.closest('.bg-white');
          if (card) card.remove();
          closeDeleteDialog();
          showToast("Record deleted successfully", "success");
        } else {
          showToast("Delete failed: " + (data.message || "Unknown error"), "error");
          resetDeleteButton();
        }
      } catch (error) {
        showToast("Error deleting record", "error");
        console.error(error);
        resetDeleteButton();
      }
    });

    function closeDeleteDialog() {
      document.getElementById('delete-confirm-dialog').classList.add('hidden');
      currentDeleteId = null;
      currentDeleteBtn = null;
    }

    function resetDeleteButton() {
      if (currentDeleteBtn) {
        currentDeleteBtn.disabled = false;
        currentDeleteBtn.textContent = 'Delete';
      }
    }

    // Send Help button AJAX with toast notifications
    async function sendHelp(imageId, diseaseName, username, email) {
      const formData = new FormData();
      formData.append('image_id', imageId);
      formData.append('disease_name', diseaseName);
      formData.append('username', username);
      formData.append('email', email);

      try {
        const resp = await fetch('/send_help', {
          method: 'POST',
          body: formData
        });
        const data = await resp.json();

        if (data.success) {
          showToast(data.message || "Help request sent successfully", "success");
        } else {
          showToast(data.message || "Failed to send help request", "error");
        }
      } catch (err) {
        showToast("Error sending help request", "error");
        console.error(err);
      }
    }

    // Toast UI helper
    function showToast(message, type = "success") {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;

      container.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => container.removeChild(toast), 500);
      }, 3000);
    }
  </script>
</body>
</html>
